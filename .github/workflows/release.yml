name: Release
run-name: "Release on ${{ github.ref_name }} bump ${{ inputs.bump }} | bump_tag=${{ inputs.do_bump_and_tag }} crates=${{ inputs.do_publish_crates }} github=${{ inputs.do_github_release }}"

# Requirements (do not remove):
# - Target platform: Windows (MSVC), we ship rust-switcher.exe zipped for GitHub Release
# - Rust toolchain: nightly, pinned by rust-toolchain.toml in repo root
# - Release flow:
#   Step 1: bump version + commit + tag + push (main)
#   Step 2: publish to crates.io from tag
#   Step 3: build Windows zip from tag
#   Step 4: create GitHub Release and attach the zip (tag)
# - Caching and tooling:
#   - Use Swatinem/rust-cache@v2 in all jobs to cache cargo registry, git deps, and target artifacts
#   - Use cargo-binstall to install helper cargo subcommands fast (cargo-set-version)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (used only when do_bump_and_tag=true)"
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major

      do_bump_and_tag:
        description: "Step 1 (Windows): bump version, commit, create tag, push to main"
        type: boolean
        required: true
        default: true

      do_publish_crates:
        description: "Step 2 (Windows): publish to crates.io (uses tag ref)"
        type: boolean
        required: true
        default: true

      do_github_release:
        description: "Steps 3-4: build Windows zip + publish GitHub Release (uses tag ref)"
        type: boolean
        required: true
        default: true

      existing_tag:
        description: "Existing tag to use when do_bump_and_tag=false (example v1.2.3)"
        type: string
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  bump_and_tag:
    name: "Step 1 - bump version and create tag on main (Windows)"
    runs-on: windows-latest
    if: "${{ inputs.do_bump_and_tag }}"

    outputs:
      tag: "${{ steps.version.outputs.tag }}"
      version: "${{ steps.version.outputs.version }}"

    steps:
      - name: Verify main branch
        if: "${{ github.ref != 'refs/heads/main' }}"
        shell: pwsh
        run: |
          Write-Error "Release workflow must be run on main branch when do_bump_and_tag=true. Current ref: $env:GITHUB_REF"
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: pwsh
        run: |
          $vv = (rustc -Vv) -join "`n"
          Write-Host $vv
          if ($vv -notmatch "release:\s+.*nightly") {
            Write-Error "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly."
            exit 1
          }

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@v1.16.6

      - name: Install cargo-set-version via binstall
        shell: pwsh
        run: cargo binstall cargo-set-version -y

      - name: Compute next version from latest repo tag and Cargo.toml, set version, update lock
        id: version
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          function Parse-SemVer([string]$s) {
            if ($s -match '^(\d+)\.(\d+)\.(\d+)$') {
              return [pscustomobject]@{
                Major = [int]$Matches[1]
                Minor = [int]$Matches[2]
                Patch = [int]$Matches[3]
              }
            }
            return $null
          }

          function Compare-SemVer($a, $b) {
            if ($a.Major -ne $b.Major) { return [Math]::Sign($a.Major - $b.Major) }
            if ($a.Minor -ne $b.Minor) { return [Math]::Sign($a.Minor - $b.Minor) }
            return [Math]::Sign($a.Patch - $b.Patch)
          }

          function SemVer-ToString($v) { return "$($v.Major).$($v.Minor).$($v.Patch)" }

          function Bump-SemVer($v, [string]$bumpKind) {
            $n = [pscustomobject]@{ Major = $v.Major; Minor = $v.Minor; Patch = $v.Patch }
            switch ($bumpKind) {
              "major" { $n.Major++; $n.Minor = 0; $n.Patch = 0 }
              "minor" { $n.Minor++; $n.Patch = 0 }
              "patch" { $n.Patch++ }
              default { throw "Unexpected bump kind: $bumpKind" }
            }
            return $n
          }

          $bump = "${{ inputs.bump }}"

          $meta = cargo metadata --no-deps --format-version 1 | ConvertFrom-Json
          if (-not $meta.workspace_members -or $meta.workspace_members.Count -lt 1) {
            throw "cargo metadata returned empty workspace_members"
          }
          $memberId = $meta.workspace_members[0]
          $pkg = $meta.packages | Where-Object { $_.id -eq $memberId } | Select-Object -First 1
          if (-not $pkg) { throw "Unable to determine workspace root package from cargo metadata" }

          $currentVersionStr = $pkg.version
          $current = Parse-SemVer $currentVersionStr
          if ($null -eq $current) { throw "Current Cargo.toml version is not semver X.Y.Z: $currentVersionStr" }

          $tagsRaw = git ls-remote --tags origin "refs/tags/v[0-9]*.[0-9]*.[0-9]*"
          $latestTag = $null
          foreach ($line in $tagsRaw) {
            $parts = $line -split "`t"
            if ($parts.Count -lt 2) { continue }
            $ref = $parts[1]
            if ($ref -notmatch '^refs/tags/v(\d+)\.(\d+)\.(\d+)$') { continue }
            $sv = [pscustomobject]@{
              Major = [int]$Matches[1]
              Minor = [int]$Matches[2]
              Patch = [int]$Matches[3]
            }
            if ($null -eq $latestTag) { $latestTag = $sv; continue }
            if ((Compare-SemVer $sv $latestTag) -gt 0) { $latestTag = $sv }
          }

          if ($null -eq $latestTag) {
            $latestTag = [pscustomobject]@{ Major = 0; Minor = 0; Patch = 0 }
          }

          $base = $latestTag
          if ((Compare-SemVer $current $base) -gt 0) { $base = $current }

          $candidate = Bump-SemVer $base $bump

          $maxRetries = 500
          for ($i = 0; $i -lt $maxRetries; $i++) {
            $version = SemVer-ToString $candidate
            $tag = "v$version"

            if ($version -eq $currentVersionStr) {
              $candidate.Patch++
              continue
            }

            $remoteTag = git ls-remote --tags origin "refs/tags/$tag"
          if ($remoteTag) {
              $candidate.Patch++
              continue
            }

            cargo set-version $version
            $changed = git diff --name-only -- Cargo.toml
            if (-not $changed) {
              throw "cargo set-version produced no changes for version=$version"
            }

            cargo generate-lockfile

            "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            break
          }

          if (-not (Test-Path $env:GITHUB_OUTPUT)) { throw "GITHUB_OUTPUT not found" }

      - name: Configure git identity
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit release changes
        shell: pwsh
        run: |
          git add Cargo.toml Cargo.lock
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            throw "No changes to commit after version selection. version=${{ steps.version.outputs.version }} tag=${{ steps.version.outputs.tag }}"
          }
          git commit -m "release: ${{ steps.version.outputs.tag }}"

      - name: Create tag locally
        shell: pwsh
        run: git tag "${{ steps.version.outputs.tag }}"

      - name: Push commit and tag to origin
        shell: pwsh
        run: git push --atomic origin HEAD:main "${{ steps.version.outputs.tag }}"

  determine_tag:
    name: Determine tag to use
    runs-on: ubuntu-latest
    needs: bump_and_tag
    if: "${{ always() && (inputs.do_bump_and_tag || inputs.existing_tag != '') }}"

    outputs:
      tag: "${{ steps.resolve.outputs.tag }}"

    steps:
      - name: Resolve tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.do_bump_and_tag }}" = "true" ]; then
            if [ "${{ needs.bump_and_tag.result }}" != "success" ]; then
              echo "bump_and_tag did not succeed, cannot proceed" >&2
              exit 1
            fi
            echo "tag=${{ needs.bump_and_tag.outputs.tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${{ inputs.existing_tag }}" ]; then
            echo "existing_tag is required when do_bump_and_tag=false" >&2
            exit 1
          fi

          echo "tag=${{ inputs.existing_tag }}" >> "$GITHUB_OUTPUT"

  build_windows_binary:
    name: "Step 3 - build Windows binary (tag ref)"
    runs-on: windows-latest
    needs: determine_tag
    if: "${{ inputs.do_github_release }}"

    outputs:
      exe: "${{ steps.build.outputs.exe }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: pwsh
        run: |
          $vv = (rustc -Vv) -join "`n"
          Write-Host $vv
          if ($vv -notmatch "release:\s+.*nightly") {
            Write-Error "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly."
            exit 1
          }

      - name: Build (locked)
        id: build
        shell: pwsh
        run: |
          cargo build -p rust-switcher --release --locked
          "exe=target/release/rust-switcher.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: "${{ steps.build.outputs.exe }}"
          if-no-files-found: error

  build_windows_asset:
    name: "Step 4 - package Windows zip (tag ref)"
    runs-on: windows-latest
    needs: [determine_tag, build_windows_binary]
    if: "${{ inputs.do_github_release }}"

    outputs:
      asset: "${{ steps.package.outputs.asset }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: pwsh
        run: |
          $vv = (rustc -Vv) -join "`n"
          Write-Host $vv
          if ($vv -notmatch "release:\s+.*nightly") {
            Write-Error "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly."
            exit 1
          }

      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary

      - name: Package zip
        id: package
        shell: pwsh
        run: |
          $meta = cargo metadata --no-deps --format-version 1 | ConvertFrom-Json
          $memberId = $meta.workspace_members[0]
          $pkg = $meta.packages | Where-Object { $_.id -eq $memberId } | Select-Object -First 1
          if (-not $pkg) { throw "Unable to determine workspace root package from cargo metadata" }

          $version = $pkg.version
          $asset = "rust-switcher-$version-windows-x86_64.zip"

          Compress-Archive -Path "rust-switcher.exe" -DestinationPath $asset -Force
          "asset=$asset" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-asset
          path: "${{ steps.package.outputs.asset }}"
          if-no-files-found: error

  publish_crates:
    name: "Step 2 - publish to crates.io (tag ref)"
    runs-on: windows-latest
    needs: determine_tag
    if: "${{ inputs.do_publish_crates }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: pwsh
        run: |
          $vv = (rustc -Vv) -join "`n"
          Write-Host $vv
          if ($vv -notmatch "release:\s+.*nightly") {
            Write-Error "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly."
            exit 1
          }

      - name: Publish to crates.io (no verify)
        env:
          CARGO_REGISTRY_TOKEN: "${{ secrets.CARGO_REGISTRY_TOKEN }}"
        run: cargo publish --locked --no-verify

  github_release:
    name: "Step 5 - publish GitHub Release (tag ref)"
    runs-on: ubuntu-latest
    needs: [determine_tag, build_windows_asset]
    if: "${{ inputs.do_github_release }}"

    steps:
      - name: Download Windows asset
        uses: actions/download-artifact@v4
        with:
          name: windows-asset

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ needs.determine_tag.outputs.tag }}"
          name: "${{ needs.determine_tag.outputs.tag }}"
          files: "*.zip"
