name: Release
run-name: "Release (bump=${{ inputs.bump }})"

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump type
        type: choice
        required: true
        default: patch
        options: [patch, minor, major]

permissions: {}

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  PACKAGE_NAME: rust-switcher

jobs:
  prepare_release:
    name: Step 1 - bump via PR to dev, merge dev -> main, tag main
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      tag: ${{ steps.bump.outputs.tag }}
      version: ${{ steps.bump.outputs.version }}

    steps:
      - name: Verify dev branch
        if: ${{ github.ref != 'refs/heads/dev' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Release workflow must be run on dev branch. Current ref: $GITHUB_REF" >&2
          exit 1

      - name: Checkout dev
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
          persist-credentials: false

      - name: Install system deps
        uses: ./.github/actions/install-ubuntu-packages
        with:
          packages: jq git curl ca-certificates gh

      - name: Install Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          toolchain-file: rust-toolchain.toml
          profile: minimal
          extra-components: rustfmt clippy

      - name: Bump version, update lock, compute tag
        id: bump
        uses: ./.github/actions/bump-cargo-version
        with:
          bump: ${{ inputs.bump }}
          package_name: ${{ env.PACKAGE_NAME }}

      - name: Configure git identity
        uses: ./.github/actions/git-config-bot

      - name: Create bump branch and commit
        id: bump_commit
        uses: ./.github/actions/commit-version-bump
        with:
          tag: ${{ steps.bump.outputs.tag }}

      - name: Push bump branch
        id: push_bump
        uses: ./.github/actions/push-branch
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          branch: ${{ steps.bump_commit.outputs.branch }}
          delete-existing: 'true'

      - name: Create PR bump branch -> dev
        id: pr_bump
        uses: ./.github/actions/gh-create-pr
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          base: dev
          head: ${{ steps.bump_commit.outputs.branch }}
          title: "release: ${{ steps.bump.outputs.tag }}"
          body: ""

      - name: Cleanup on PR creation failure
        if: ${{ failure() && steps.push_bump.outcome == 'success' }}
        shell: bash
        env:
          TOKEN: ${{ secrets.RELEASE_TOKEN }}
          BRANCH: ${{ steps.bump_commit.outputs.branch }}
        run: |
          set -euo pipefail
          echo "[ERROR] PR creation failed, cleaning up branch: $BRANCH" >&2
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin --delete "$BRANCH" || true
          echo "[INFO] Cleaned up remote branch"

      - name: Wait for required checks on bump PR
        uses: ./.github/actions/gh-pr-checks
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          pr_number: ${{ steps.pr_bump.outputs.number }}

      - name: Merge bump PR into dev
        uses: ./.github/actions/gh-pr-merge
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          pr_number: ${{ steps.pr_bump.outputs.number }}
          method: squash
          delete_branch: true
          admin: false
          subject: "release: ${{ steps.bump.outputs.tag }}"
          body: ""

      - name: Create PR dev -> main and merge
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          TAG: ${{ steps.bump.outputs.tag }}
        run: |
          set -euo pipefail

          pr_number="$(gh pr list --base main --head dev --state open --json number --jq '.[0].number // empty')"
          if [ -z "$pr_number" ]; then
            pr_url="$(gh pr create --base main --head dev --title "release: $TAG" --body "")"
            pr_number="$(echo "$pr_url" | sed -n 's#.*/pull/##p')"
          fi

          gh pr merge "$pr_number" --squash --admin --subject "release: $TAG" --body ""

      - name: Tag main at merged commit and push tag
        uses: ./.github/actions/tag-main-and-push
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag: ${{ steps.bump.outputs.tag }}

  release_build_publish:
    name: Step 2 - build Windows zip, publish GitHub Release, publish crates.io (tag ref)
    runs-on: ubuntu-latest
    needs: prepare_release
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout at tag
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          ref: ${{ needs.prepare_release.outputs.tag }}
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
          persist-credentials: false

      - name: Install system deps (zip, mingw)
        uses: ./.github/actions/install-ubuntu-packages
        with:
          packages: curl ca-certificates zip mingw-w64

      - name: Install Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          toolchain-file: rust-toolchain.toml
          profile: minimal

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: release

      - name: Install Windows GNU target
        shell: bash
        run: |
          set -euo pipefail
          rustup target add x86_64-pc-windows-gnu

      - name: Build (locked, Windows GNU target)
        shell: bash
        run: |
          set -euo pipefail
          cargo build -p rust-switcher --release --locked --target x86_64-pc-windows-gnu

      - name: Package Windows zip
        id: package
        uses: ./.github/actions/package-windows-zip
        with:
          version: ${{ needs.prepare_release.outputs.version }}

      - name: Publish GitHub Release (attach zip)
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag_name: ${{ needs.prepare_release.outputs.tag }}
          name: ${{ needs.prepare_release.outputs.tag }}
          files: |
            ${{ steps.package.outputs.asset }}
          fail_on_unmatched_files: true

      - name: Authenticate to crates.io via OIDC (trusted publishing)
        id: auth
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1

      - name: Publish to crates.io
        id: publish
        continue-on-error: true
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          set -euo pipefail
          cargo publish --locked --no-verify

      - name: Rollback GitHub Release and tag if publish failed
        if: ${{ steps.publish.outcome != 'success' }}
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          TAG: ${{ needs.prepare_release.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail

          gh release delete "$TAG" -y || true

          git init -q tmp && cd tmp
          git remote add origin "https://x-access-token:${RELEASE_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin ":refs/tags/$TAG" || true

          echo "crates.io publish failed, rolled back GitHub Release and tag: $TAG" >&2
          exit 1
