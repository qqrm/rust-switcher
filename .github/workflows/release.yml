name: Release
run-name: "Release on ${{ github.ref_name }} bump ${{ inputs.bump }} | bump_tag=${{ inputs.do_bump_and_tag }} crates=${{ inputs.do_publish_crates }} github=${{ inputs.do_github_release }}"

# Requirements (do not remove):
# - Target platform: Linux, we ship rust-switcher binary packaged for GitHub Release
# - Rust toolchain: nightly, pinned by rust-toolchain.toml in repo root
# - Release flow:
#   Step 1: bump version + commit + tag + push (main)
#   Step 2: publish to crates.io from tag
#   Step 3: build Linux archive from tag
#   Step 4: create GitHub Release and attach the archive (tag)
# - Caching and tooling:
#   - Use Swatinem/rust-cache@v2 in all jobs to cache cargo registry, git deps, and target artifacts
#   - Use cargo-binstall to install helper cargo subcommands fast (cargo-set-version)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (used only when do_bump_and_tag=true)"
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major

      do_bump_and_tag:
        description: "Step 1 (Linux): bump version, commit, create tag, push to main"
        type: boolean
        required: true
        default: true

      do_publish_crates:
        description: "Step 2 (Linux): publish to crates.io (uses tag ref)"
        type: boolean
        required: true
        default: true

      do_github_release:
        description: "Steps 3-4: build Linux archive + publish GitHub Release (uses tag ref)"
        type: boolean
        required: true
        default: true

      existing_tag:
        description: "Existing tag to use when do_bump_and_tag=false (example v1.2.3)"
        type: string
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  bump_and_tag:
    name: "Step 1 - bump version and create tag on main (Linux)"
    runs-on: ubuntu-latest
    if: "${{ inputs.do_bump_and_tag }}"

    outputs:
      tag: "${{ steps.version.outputs.tag }}"
      version: "${{ steps.version.outputs.version }}"

    steps:
      - name: Verify main branch
        if: "${{ github.ref != 'refs/heads/main' }}"
        shell: bash
        run: |
          echo "Release workflow must be run on main branch when do_bump_and_tag=true. Current ref: $GITHUB_REF" >&2
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          if ! rustc -Vv | grep -q "release:.*nightly"; then
            echo "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly." >&2
            exit 1
          fi

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@v1.16.6

      - name: Install cargo-set-version via binstall
        shell: bash
        run: cargo binstall cargo-set-version -y

      - name: Compute next version from latest repo tag and Cargo.toml, set version, update lock
        id: version
        shell: bash
        env:
          BUMP: "${{ inputs.bump }}"
        run: |
          set -euo pipefail

          read -r version tag < <(python - <<'PY'
import json
import os
import re
import subprocess
import sys

bump = os.environ["BUMP"]


def parse(s: str):
    match = re.match(r"^(\d+)\.(\d+)\.(\d+)$", s)
    if not match:
        return None
    return tuple(int(part) for part in match.groups())


def bump_ver(version, kind: str):
    major, minor, patch = version
    if kind == "major":
        return (major + 1, 0, 0)
    if kind == "minor":
        return (major, minor + 1, 0)
    if kind == "patch":
        return (major, minor, patch + 1)
    raise SystemExit(f"Unexpected bump kind: {kind}")


meta = json.loads(
    subprocess.check_output(["cargo", "metadata", "--no-deps", "--format-version", "1"])
)
member_id = meta["workspace_members"][0]
pkg = next(pkg for pkg in meta["packages"] if pkg["id"] == member_id)
current_version = pkg["version"]
current = parse(current_version)
if current is None:
    raise SystemExit(f"Current Cargo.toml version is not semver X.Y.Z: {current_version}")

tags_raw = subprocess.check_output(
    ["git", "ls-remote", "--tags", "origin", "refs/tags/v[0-9]*.[0-9]*.[0-9]*"]
).decode()
tags = []
for line in tags_raw.splitlines():
    parts = line.split("\t")
    if len(parts) < 2:
        continue
    ref = parts[1]
    match = re.match(r"^refs/tags/v(\d+)\.(\d+)\.(\d+)$", ref)
    if not match:
        continue
    tags.append(tuple(int(part) for part in match.groups()))

latest = max(tags) if tags else (0, 0, 0)
base = max(current, latest)
candidate = bump_ver(base, bump)
for _ in range(500):
    version = f"{candidate[0]}.{candidate[1]}.{candidate[2]}"
    tag = f"v{version}"
    if version == current_version:
        candidate = (candidate[0], candidate[1], candidate[2] + 1)
        continue
    remote = subprocess.check_output(
        ["git", "ls-remote", "--tags", "origin", f"refs/tags/{tag}"]
    ).decode().strip()
    if remote:
        candidate = (candidate[0], candidate[1], candidate[2] + 1)
        continue
    print(version, tag)
    sys.exit(0)

raise SystemExit("Failed to find available version tag after 500 attempts")
PY
          )

          cargo set-version "$version"
          if [ -z "$(git diff --name-only -- Cargo.toml)" ]; then
            echo "cargo set-version produced no changes for version=$version" >&2
            exit 1
          fi

          cargo generate-lockfile

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Configure git identity
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit release changes
        shell: bash
        run: |
          git add Cargo.toml Cargo.lock
          git diff --cached --quiet
          if [ $? -eq 0 ]; then
            echo "No changes to commit after version selection. version=${{ steps.version.outputs.version }} tag=${{ steps.version.outputs.tag }}" >&2
            exit 1
          fi
          git commit -m "release: ${{ steps.version.outputs.tag }}"

      - name: Create tag locally
        shell: bash
        run: git tag "${{ steps.version.outputs.tag }}"

      - name: Push commit and tag to origin
        shell: bash
        run: git push --atomic origin HEAD:main "${{ steps.version.outputs.tag }}"

  determine_tag:
    name: Determine tag to use
    runs-on: ubuntu-latest
    needs: bump_and_tag
    if: "${{ always() && (inputs.do_bump_and_tag || inputs.existing_tag != '') }}"

    outputs:
      tag: "${{ steps.resolve.outputs.tag }}"

    steps:
      - name: Resolve tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.do_bump_and_tag }}" = "true" ]; then
            if [ "${{ needs.bump_and_tag.result }}" != "success" ]; then
              echo "bump_and_tag did not succeed, cannot proceed" >&2
              exit 1
            fi
            echo "tag=${{ needs.bump_and_tag.outputs.tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${{ inputs.existing_tag }}" ]; then
            echo "existing_tag is required when do_bump_and_tag=false" >&2
            exit 1
          fi

          echo "tag=${{ inputs.existing_tag }}" >> "$GITHUB_OUTPUT"

  build_linux_binary:
    name: "Step 3 - build Linux binary (tag ref)"
    runs-on: ubuntu-latest
    needs: determine_tag
    if: "${{ inputs.do_github_release }}"

    outputs:
      bin: "${{ steps.build.outputs.bin }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          if ! rustc -Vv | grep -q "release:.*nightly"; then
            echo "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly." >&2
            exit 1
          fi

      - name: Build (locked)
        id: build
        shell: bash
        run: |
          set -euo pipefail
          cargo build -p rust-switcher --release --locked
          echo "bin=target/release/rust-switcher" >> "$GITHUB_OUTPUT"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: "${{ steps.build.outputs.bin }}"
          if-no-files-found: error

  build_linux_asset:
    name: "Step 4 - package Linux archive (tag ref)"
    runs-on: ubuntu-latest
    needs: [determine_tag, build_linux_binary]
    if: "${{ inputs.do_github_release }}"

    outputs:
      asset: "${{ steps.package.outputs.asset }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          if ! rustc -Vv | grep -q "release:.*nightly"; then
            echo "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly." >&2
            exit 1
          fi

      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary

      - name: Package archive
        id: package
        shell: bash
        run: |
          set -euo pipefail

          version=$(cargo metadata --no-deps --format-version 1 | python - <<'PY'
import json
import sys

meta = json.load(sys.stdin)
member_id = meta["workspace_members"][0]
pkg = next(pkg for pkg in meta["packages"] if pkg["id"] == member_id)
print(pkg["version"])
PY
          )

          asset="rust-switcher-$version-linux-x86_64.tar.gz"
          chmod +x rust-switcher
          tar -czf "$asset" rust-switcher
          echo "asset=$asset" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-asset
          path: "${{ steps.package.outputs.asset }}"
          if-no-files-found: error

  publish_crates:
    name: "Step 2 - publish to crates.io (tag ref)"
    runs-on: ubuntu-latest
    needs: determine_tag
    if: "${{ inputs.do_publish_crates }}"

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.determine_tag.outputs.tag }}"

      - name: Setup Rust toolchain (rust-toolchain.toml)
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust build (cargo, target)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release"

      - name: Verify nightly toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          if ! rustc -Vv | grep -q "release:.*nightly"; then
            echo "Expected nightly toolchain from rust-toolchain.toml, but rustc -Vv does not show nightly." >&2
            exit 1
          fi

      - name: Publish to crates.io (no verify)
        env:
          CARGO_REGISTRY_TOKEN: "${{ secrets.CARGO_REGISTRY_TOKEN }}"
        run: cargo publish --locked --no-verify

  github_release:
    name: "Step 5 - publish GitHub Release (tag ref)"
    runs-on: ubuntu-latest
    needs: [determine_tag, build_linux_asset]
    if: "${{ inputs.do_github_release }}"

    steps:
      - name: Download Linux asset
        uses: actions/download-artifact@v4
        with:
          name: linux-asset

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ needs.determine_tag.outputs.tag }}"
          name: "${{ needs.determine_tag.outputs.tag }}"
          files: "*.tar.gz"
