name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  pull-requests: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.93.1
      - name: Build release
        run: cargo build --release
      - name: Package artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $metadata = cargo metadata --no-deps --format-version 1 | ConvertFrom-Json
          $package = $metadata.packages | Where-Object { $_.name -eq 'rust-switcher' }
          if (-not $package) {
            throw 'Package rust-switcher not found in cargo metadata.'
          }
          $binTarget = $package.targets | Where-Object { $_.kind -contains 'bin' } | Select-Object -First 1
          if (-not $binTarget) {
            throw 'Binary target not found in cargo metadata.'
          }
          $binName = $binTarget.name
          $exePath = "target\\release\\$binName.exe"
          if (-not (Test-Path $exePath)) {
            throw "Executable not found at $exePath"
          }
          $artifactsDir = "artifacts"
          New-Item -ItemType Directory -Force -Path $artifactsDir | Out-Null
          Copy-Item $exePath -Destination $artifactsDir
          $zipPath = Join-Path $artifactsDir "$binName-${{ github.ref_name }}-windows-x64.zip"
          $zipItems = @($exePath)
          foreach ($item in @('README.md', 'LICENSE')) {
            if (Test-Path $item) {
              $zipItems += $item
            }
          }
          if (Test-Path "config.example.json") {
            $zipItems += "config.example.json"
          }
          Compress-Archive -Path $zipItems -DestinationPath $zipPath -Force
          $exeSha = Join-Path $artifactsDir "$binName.exe.sha256"
          $zipSha = Join-Path $artifactsDir "$(Split-Path $zipPath -Leaf).sha256"
          (certutil -hashfile $exePath SHA256)[1] | Set-Content -Path $exeSha
          (certutil -hashfile $zipPath SHA256)[1] | Set-Content -Path $zipSha
          "exe_path=$exePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      - name: Upload assets to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ github.ref_name }}"
          gh release upload $tag artifacts\* --clobber

  publish-crates:
    runs-on: ubuntu-latest
    needs: build-windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.93.1
      - name: Publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --locked

  sync-main-to-dev:
    runs-on: ubuntu-latest
    needs: publish-crates
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Create sync PR
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          title="Sync main back to dev (${tag})"
          existing=$(gh pr list --base dev --head main --state open --json url -q '.[0].url')
          if [ -n "$existing" ]; then
            gh pr edit "$existing" --title "$title"
            gh pr merge "$existing" --auto --squash
            exit 0
          fi
          pr=$(gh pr create --base dev --head main --title "$title" --body "Sync main back to dev for ${tag}.")
          gh pr merge "$pr" --auto --squash
