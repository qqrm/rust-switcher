name: tag-and-release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  tag_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Read version
        id: version
        run: |
          python - <<'PY'
          import os
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path('Cargo.toml').read_text(encoding='utf-8'))
          version = data['package']['version']
          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"version={version}\n")
              fh.write(f"tag=v{version}\n")
          PY
      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Create tag if missing
        env:
          RELEASE_PAT: ${{ secrets.RELEASE_PAT }}
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            echo "Tag ${tag} already exists."
            exit 0
          fi
          git tag -a "${tag}" -m "Release ${tag}"
          git push "https://x-access-token:${RELEASE_PAT}@github.com/${GITHUB_REPOSITORY}.git" "${tag}"
      - name: Create GitHub Release if missing
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          if gh release view "${tag}" >/dev/null 2>&1; then
            echo "Release ${tag} already exists."
            exit 0
          fi
          gh release create "${tag}" --title "${tag}" --notes ""
