name: Promote dev to main + tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.4). Leave empty to use Cargo.toml version from dev."
        required: false
      tag_prefix:
        description: "Tag prefix"
        required: false
        default: "v"

permissions:
  contents: write

concurrency:
  group: promote-dev-to-main
  cancel-in-progress: false

jobs:
  promote:
    runs-on: windows-latest

    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev
          # Use PAT so pushing to protected branches/tags works if required by repo settings
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Determine version + tag
        id: ver
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $inputVersion = "${{ github.event.inputs.version }}"
          if (-not [string]::IsNullOrWhiteSpace($inputVersion)) {
            $version = $inputVersion.Trim()
          } else {
            $cargoToml = Get-Content -Raw -Encoding UTF8 -Path "Cargo.toml"
            $m = [regex]::Match($cargoToml, '(?m)^\s*version\s*=\s*"([^"]+)"\s*$')
            if (-not $m.Success) {
              throw "Failed to parse version from Cargo.toml"
            }
            $version = $m.Groups[1].Value
          }

          $tagPrefix = "${{ github.event.inputs.tag_prefix }}"
          if ([string]::IsNullOrWhiteSpace($tagPrefix)) { $tagPrefix = "v" }

          $tag = "$tagPrefix$version"

          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          Write-Host "Using version=$version tag=$tag"

      - name: Configure git author
        shell: pwsh
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

      - name: Fetch main
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git fetch origin main

      - name: Merge dev into main and tag
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Switch to main tracked from origin
          git checkout -B main origin/main

          # Merge dev with merge commit (safe, no ff assumptions)
          git merge --no-ff origin/dev -m "Release ${{ steps.ver.outputs.tag }}"

          $tag = "${{ steps.ver.outputs.tag }}"

          # Prevent accidental retag
          git rev-parse $tag 2>$null
          if ($LASTEXITCODE -eq 0) {
            throw "Tag $tag already exists"
          }

          git tag -a $tag -m $tag

          git push origin main
          git push origin $tag
